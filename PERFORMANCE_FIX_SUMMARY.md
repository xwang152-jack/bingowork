# æ€§èƒ½ä¼˜åŒ–å®ŒæˆæŠ¥å‘Š

## âœ… å·²å®Œæˆçš„ä¼˜åŒ–ï¼ˆä¼˜å…ˆçº§ 1ï¼‰

### 1. MessageList æ»šåŠ¨ä¼˜åŒ– (`src/components/cowork/MessageList.tsx:114-127`)

**ä¿®æ”¹å†…å®¹ï¼š**
- ç§»é™¤äº† `toolStreamById` ä¾èµ–
- æ”¹ç”¨ `streamingText.length` ä»£æ›¿ `streamingText`
- ä½¿ç”¨ `requestAnimationFrame` èŠ‚æµæ»šåŠ¨æ“ä½œ

**é¢„æœŸæ•ˆæœï¼š**
- æ»šåŠ¨æ“ä½œå‡å°‘çº¦ 90%
- é¿å…æ¯æ¬¡å·¥å…·è¾“å‡ºæµéƒ½è§¦å‘æ»šåŠ¨
- æµå¼è¾“å‡ºæ—¶å¹³æ»‘æ»šåŠ¨ï¼Œä¸å†å¡é¡¿

---

### 2. æµå¼æ–‡æœ¬æ‰¹å¤„ç† (`src/hooks/useAgent.ts`)

**ä¿®æ”¹å†…å®¹ï¼š**
- æ·»åŠ  `rafRef` ç”¨äºæ‰¹å¤„ç† token æ›´æ–°
- æ¯ä¸ª token å…ˆç´¯ç§¯åˆ° `streamingTextRef.current`
- ä½¿ç”¨ `requestAnimationFrame` æ‰¹é‡æ›´æ–°çŠ¶æ€
- æ¸…ç†æ—¶æ­£ç¡®å–æ¶ˆ RAF

**é¢„æœŸæ•ˆæœï¼š**
- çŠ¶æ€æ›´æ–°é¢‘ç‡ä»æ¯ä¸ª token â†’ æ¯å¸§ï¼ˆçº¦ 16msï¼‰
- å‡å°‘ 80-90% çš„çŠ¶æ€æ›´æ–°å’Œé‡æ¸²æŸ“
- UI å“åº”æ›´æµç•…

---

### 3. MarkdownRenderer ä¼˜åŒ– (`src/components/MarkdownRenderer.tsx`)

**ä¿®æ”¹å†…å®¹ï¼š**
- æ·»åŠ è‡ªå®šä¹‰æ¯”è¾ƒå‡½æ•° `areMarkdownPropsEqual`
- åªåœ¨å†…å®¹çœŸæ­£å˜åŒ–æ—¶é‡æ–°æ¸²æŸ“

**é¢„æœŸæ•ˆæœï¼š**
- å‡å°‘ä¸å¿…è¦çš„ Markdown é‡æ–°è§£æ
- çˆ¶ç»„ä»¶é‡æ¸²æŸ“æ—¶ä¸å½±å“ MarkdownRenderer

---

### 4. ChatInput ä¾èµ–ä¼˜åŒ– (`src/components/cowork/ChatInput.tsx:48-57`)

**ä¿®æ”¹å†…å®¹ï¼š**
- ä» `handleSend` çš„ä¾èµ–æ•°ç»„ä¸­ç§»é™¤ `content` å’Œ `images`
- ä¿æŒåŠŸèƒ½ä¸å˜ï¼Œä½†å‡å°‘å›è°ƒé‡æ–°åˆ›å»º

**é¢„æœŸæ•ˆæœï¼š**
- è¾“å…¥æ—¶å‡å°‘å›è°ƒé‡æ–°åˆ›å»º
- è½»å¾®æå‡è¾“å…¥å“åº”é€Ÿåº¦

---

### 5. å¼‚æ­¥ä¼šè¯ä¿å­˜ (`src/hooks/useAgent.ts:36-48`)

**ä¿®æ”¹å†…å®¹ï¼š**
- ä½¿ç”¨ `setTimeout` å°†ä¼šè¯ä¿å­˜æ¨è¿Ÿåˆ°ä¸‹ä¸€ä¸ªäº‹ä»¶å¾ªç¯
- æ·±æ‹·è´æ“ä½œä¸å†é˜»å¡ UI çº¿ç¨‹

**é¢„æœŸæ•ˆæœï¼š**
- æ¶ˆé™¤ä¿å­˜ä¼šè¯æ—¶çš„ UI å¡é¡¿
- å†å²æ›´æ–°æ›´æµç•…

---

## ğŸ“Š é¢„æœŸæ•´ä½“æ€§èƒ½æå‡

| æŒ‡æ ‡ | ä¿®æ”¹å‰ | ä¿®æ”¹å | æå‡ |
|------|--------|--------|------|
| æ»šåŠ¨æ“ä½œæ¬¡æ•° | 1000+ æ¬¡/ç§’ | ~60 æ¬¡/ç§’ | **90% â†“** |
| çŠ¶æ€æ›´æ–°é¢‘ç‡ | æ¯ä¸ª token | æ¯å¸§ï¼ˆ16msï¼‰ | **95% â†“** |
| é‡æ¸²æŸ“æ¬¡æ•° | 50-100 æ¬¡/ç§’ | 5-10 æ¬¡/ç§’ | **90% â†“** |
| Markdown è§£æ | æ¯ä¸ª token | ä»…å†…å®¹å˜åŒ–æ—¶ | **80% â†“** |
| ä¼šè¯ä¿å­˜é˜»å¡ | åŒæ­¥é˜»å¡ | å¼‚æ­¥ä¸é˜»å¡ | **100% â†“** |

---

## ğŸ§ª æµ‹è¯•å»ºè®®

### 1. åŠŸèƒ½æµ‹è¯•
```bash
# å¯åŠ¨å¼€å‘æœåŠ¡å™¨
npm run dev

# æµ‹è¯•åœºæ™¯ï¼š
# 1. è¾“å…¥çŸ­æ¶ˆæ¯ï¼Œè§‚å¯Ÿå“åº”é€Ÿåº¦
# 2. è¾“å…¥é•¿æ¶ˆæ¯ï¼Œè§‚å¯Ÿæ˜¯å¦æœ‰å¡é¡¿
# 3. AI æµå¼è¾“å‡ºæ—¶ï¼Œè§‚å¯Ÿæ»šåŠ¨æ˜¯å¦å¹³æ»‘
# 4. ä½¿ç”¨å·¥å…·å‘½ä»¤ï¼Œè§‚å¯Ÿå·¥å…·è¾“å‡ºæ˜¯å¦æµç•…
```

### 2. æ€§èƒ½æµ‹è¯•
ä½¿ç”¨ Chrome DevTools Performanceï¼š
1. æ‰“å¼€ DevTools â†’ Performance
2. ç‚¹å‡» Record
3. å‘é€ä¸€æ¡æ¶ˆæ¯å¹¶ç­‰å¾… AI å›å¤
4. åœæ­¢å½•åˆ¶
5. æŸ¥çœ‹ FPS å’Œé‡æ¸²æŸ“æ¬¡æ•°

**é¢„æœŸç»“æœï¼š**
- FPS ä¿æŒåœ¨ 55-60
- æ²¡æœ‰æ˜æ˜¾çš„é•¿ä»»åŠ¡ï¼ˆ>50msï¼‰
- é‡æ¸²æŸ“æ¬¡æ•°æ˜¾è‘—å‡å°‘

---

## ğŸ” è¿›ä¸€æ­¥ä¼˜åŒ–å»ºè®®

å¦‚æœä»æœ‰æ€§èƒ½é—®é¢˜ï¼Œå¯ä»¥è€ƒè™‘ï¼š

### 1. MessageItem æ·±åº¦æ¯”è¾ƒ
ä½¿ç”¨ `fast-equals` æˆ– `lodash.isEqual` è¿›è¡Œæ·±åº¦æ¯”è¾ƒï¼š
```typescript
import { fastDeepEqual } from 'fast-equals';

const areMessageEqual = (prevProps: MessageItemProps, nextProps: MessageItemProps) => {
    return (
        fastDeepEqual(prevProps.message, nextProps.message) &&
        prevProps.isDark === nextProps.isDark
    );
};
```

### 2. è™šæ‹ŸåŒ–é•¿åˆ—è¡¨
å¯¹äºåŒ…å« 50+ æ¡æ¶ˆæ¯çš„ä¼šè¯ï¼Œä½¿ç”¨ `react-window`ï¼š
```bash
npm install react-window
```

### 3. Web Worker Markdown è§£æ
å°† Markdown è§£æç§»åˆ° Worker çº¿ç¨‹ã€‚

---

## ğŸ“ ä¿®æ”¹çš„æ–‡ä»¶

1. âœ… `src/components/cowork/MessageList.tsx` - æ»šåŠ¨ä¼˜åŒ–
2. âœ… `src/hooks/useAgent.ts` - æµå¼æ–‡æœ¬æ‰¹å¤„ç†ã€å¼‚æ­¥ä¿å­˜
3. âœ… `src/components/MarkdownRenderer.tsx` - è‡ªå®šä¹‰æ¯”è¾ƒå‡½æ•°
4. âœ… `src/components/cowork/ChatInput.tsx` - ä¾èµ–ä¼˜åŒ–

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **ç±»å‹æ£€æŸ¥å·²é€šè¿‡**ï¼š`npm run typecheck` âœ“
2. **æœªå¼•å…¥æ–°çš„ä¾èµ–**ï¼šæ‰€æœ‰ä¼˜åŒ–ä½¿ç”¨åŸç”Ÿ API
3. **å‘åå…¼å®¹**ï¼šæ²¡æœ‰æ”¹å˜ç»„ä»¶ API æˆ–è¡Œä¸º

---

## ğŸš€ ä¸‹ä¸€æ­¥

1. åœ¨å¼€å‘ç¯å¢ƒæµ‹è¯•ä¼˜åŒ–æ•ˆæœ
2. å¦‚æœæ•ˆæœæ˜æ˜¾ï¼Œè€ƒè™‘åˆå¹¶åˆ°ä¸»åˆ†æ”¯
3. ä½¿ç”¨ React DevTools Profiler éªŒè¯å®é™…æ€§èƒ½æå‡
4. æ ¹æ®å®é™…æ•ˆæœå†³å®šæ˜¯å¦å®æ–½ä¼˜å…ˆçº§ 2 å’Œ 3 çš„ä¼˜åŒ–

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- è¯¦ç»†çš„æ€§èƒ½åˆ†ææŠ¥å‘Šï¼š`PERFORMANCE_ANALYSIS.md`
- React æ€§èƒ½ä¼˜åŒ–å®˜æ–¹æ–‡æ¡£ï¼šhttps://react.dev/learn/render-and-commit
- requestAnimationFrame MDNï¼šhttps://developer.mozilla.org/en-US/docs/Web/API/window/requestAnimationFrame
